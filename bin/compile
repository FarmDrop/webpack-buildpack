#!/bin/bash

# $1 is the build dir
cd $1

# ENV vars are not injected into the environment, but are written one per file
# to a directory. $3 is the directory path.
# https://devcenter.heroku.com/articles/buildpack-api#bin-compile
RAILS_ENV=$(cat $3/RAILS_ENV) bundle exec rake webpack:compile --trace

rake_task_exists() {
  if [[ $(bundle exec rake --tasks | grep rollbar:upload_source_maps | wc -l | xargs) == 1 ]]; then
    echo "Found the rake task to upload the source maps";
    return 0;
  else
    echo "Did not find the rake task to upload source maps";
    return 1;
  fi
}

# Upload source maps to Rollbar
if rake_task_exists; then
  RAILS_ENV=$(cat $3/RAILS_ENV) SOURCE_VERSION=$SOURCE_VERSION bundle exec rake rollbar:upload_source_maps
fi